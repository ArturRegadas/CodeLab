{% extends 'base.html' %}
{% block title %}Quartos - Estada Feliz{% endblock %}

{% block content %}
<section class="page-header">
  <h2>Quartos</h2>
  <div class="actions">
    <button id="btn-novo-quarto" class="btn primary">+ Novo Quarto</button>
    <button id="btn-refresh-quartos" class="btn">Atualizar</button>
  </div>
</section>

<section class="table-wrap">
  <table id="table-quartos">
    <thead>
      <tr>
        <th>Número</th>
        <th>Tipo</th>
        <th>Status Limpeza</th>
        <th>Localização</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="pagination-quartos"></div>
</section>

<!-- Modal: criar/editar quarto -->
<div id="modal-quarto" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" id="modal-close">×</button>
    <h3 id="modal-title">Novo Quarto</h3>
    <form id="form-quarto">
      <div class="form-row">
        <label for="numero_quarto">Número do quarto</label>
        <input type="text" id="numero_quarto" name="numero_quarto" required />
      </div>

      <div class="form-row">
        <label for="id_tipo">Tipo de quarto</label>
        <select id="id_tipo" name="id_tipo" required>
          <option value="">-- Selecione --</option>
        </select>
      </div>

      <div class="form-row">
        <label for="status_limpeza">Status de limpeza</label>
        <select id="status_limpeza" name="status_limpeza">
          <option value="Sujo">Sujo</option>
          <option value="Limpo">Limpo</option>
          <option value="Em limpeza">Em limpeza</option>
        </select>
      </div>

      <div class="form-row">
        <label for="localizacao">Localização</label>
        <input type="text" id="localizacao" name="localizacao" />
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">Salvar</button>
        <button type="button" class="btn">Cancelar</button>
      </div>

      <input type="hidden" id="editing_numero" name="editing_numero" value="" />
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/forms.js') }}"></script>
<script>
async function popularSelectTipos() {
  try {
    const result = await apiGet('/tipos_quarto');
    const tipos = Array.isArray(result) ? result : result.items || [];
    const sel = document.getElementById('id_tipo');
    sel.innerHTML = '<option value="">-- Selecione --</option>';
    tipos.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id_tipo;
      opt.textContent = `${t.nome_tipo} (cap: ${t.capacidade_maxima})`;
      sel.appendChild(opt);
    });
  } catch (e) {
    console.error('Erro ao carregar tipos de quarto', e);
    document.getElementById('id_tipo').innerHTML = '<option value="">Erro ao carregar</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const modalQuarto = document.getElementById('modal-quarto');
  let currentPage = 1;

  function showModal() {
    modalQuarto.style.display = 'block';
    modalQuarto.setAttribute('aria-hidden', 'false');
  }

  function hideModal() {
    modalQuarto.style.display = 'none';
    modalQuarto.setAttribute('aria-hidden', 'true');
    document.getElementById('form-quarto').reset();
    document.getElementById('editing_numero').value = '';
    document.getElementById('modal-title').innerText = 'Novo Quarto';
  }

  document.getElementById('btn-novo-quarto').addEventListener('click', async () => {
    await popularSelectTipos();
    document.getElementById('form-quarto').reset();
    document.getElementById('editing_numero').value = '';
    document.getElementById('modal-title').innerText = 'Novo Quarto';
    showModal();
  });

  document.getElementById('btn-refresh-quartos').addEventListener('click', () => carregarQuartos(currentPage));
  document.getElementById('modal-close').addEventListener('click', hideModal);

  document.getElementById('form-quarto').addEventListener('submit', async (e) => {
    e.preventDefault();
    const editing = document.getElementById('editing_numero').value;
    const payload = {
      numero_quarto: document.getElementById('numero_quarto').value,
      id_tipo: document.getElementById('id_tipo').value || null,
      status_limpeza: document.getElementById('status_limpeza').value,
      localizacao: document.getElementById('localizacao').value || null
    };

    try {
      if (editing) {
        await apiPut(`/quartos/${editing}`, payload);
      } else {
        await apiPost('/quartos', payload);
      }
      hideModal();
      carregarQuartos(1);
    } catch (err) {
      console.error('Erro ao salvar quarto', err);
      alert('Erro ao salvar quarto: ' + (err.message || ''));
    }
  });

  // Delegação de eventos para tabela
  document.querySelector('#table-quartos tbody').addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.action;
    const num = btn.dataset.num;

    if (action === 'edit') {
      try {
        const result = await apiGet('/quartos');
        const quartos = Array.isArray(result) ? result : result.items || [];
        const q = quartos.find(x => String(x.numero_quarto) === String(num));
        if (!q) return alert('Quarto não encontrado');

        document.getElementById('numero_quarto').value = q.numero_quarto;
        document.getElementById('id_tipo').value = q.id_tipo || '';
        document.getElementById('status_limpeza').value = q.status_limpeza || 'Sujo';
        document.getElementById('localizacao').value = q.localizacao || '';
        document.getElementById('editing_numero').value = q.numero_quarto;
        document.getElementById('modal-title').innerText = 'Editar Quarto';
        await popularSelectTipos();
        showModal();
      } catch (e) {
        console.error(e);
      }
    } else if (action === 'delete') {
      if (!confirm('Confirma a remoção do quarto ' + num + '?')) return;
      try {
        await apiDelete(`/quartos/${num}`);
        carregarQuartos(1);
      } catch (e) {
        console.error(e);
        alert('Erro ao apagar quarto');
      }
    }
  });

  // Inicializa tabela
  carregarQuartos();
});
</script>
{% endblock %}
