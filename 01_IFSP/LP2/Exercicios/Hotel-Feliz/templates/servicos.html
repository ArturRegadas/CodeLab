{% extends 'base.html' %}
{% block title %}Serviços - Estada Feliz{% endblock %}

{% block content %}
<section class="page-header">
  <h2>Serviços</h2>
  <div class="actions">
    <button id="btn-novo-servico" class="btn primary">+ Novo Serviço</button>
    <button id="btn-refresh-servicos" class="btn">Atualizar</button>
  </div>
</section>

<section class="table-wrap">
  <table id="table-servicos">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Preço</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="pagination-servicos"></div>
</section>

<!-- Modal: criar/editar serviço -->
<div id="modal-servico" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" id="modal-close">×</button>
    <h3 id="modal-title">Novo Serviço</h3>
    <form id="form-servico">
      <div class="form-row">
        <label for="nome_servico">Nome do Serviço</label>
        <input type="text" id="nome_servico" name="nome_servico" required />
      </div>

      <div class="form-row">
        <label for="preco">Preço (R$)</label>
        <input type="number" id="preco" name="preco" step="0.01" required />
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">Salvar</button>
        <button type="button" class="btn">Cancelar</button>
      </div>

      <input type="hidden" id="editing_id" name="editing_id" value="" />
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function openModal() {
  const modal = document.getElementById('modal-servico');
  modal.setAttribute('aria-hidden', 'false');
}

function closeModal() {
  const modal = document.getElementById('modal-servico');
  modal.setAttribute('aria-hidden', 'true');
  document.getElementById('form-servico').reset();
  document.getElementById('editing_id').value = '';
  document.getElementById('modal-title').innerText = 'Novo Serviço';
}

async function preencherTabelaServicos() {
  try {
    const stateKey = 'servicos';
    const current = window.__paginationState[stateKey] || 1;
    const { items: servicos, meta } = await fetchPaginated('/servicos', current, 10);
    
    const tbody = document.querySelector('#table-servicos tbody');
    tbody.innerHTML = '';
    servicos.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.id_servico}</td>
        <td>${s.nome_servico}</td>
        <td>R$ ${parseFloat(s.preco).toFixed(2)}</td>
        <td>
          <button class="btn small" data-action="delete" data-id="${s.id_servico}">Apagar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    attachPaginationToTable('table-servicos', 'pagination-servicos', meta,
      (p) => { window.__paginationState[stateKey] = p; preencherTabelaServicos(); });
  } catch (e) {
    console.error('Erro ao preencher tabela de serviços', e);
  }
}

async function apagarServico(id) {
  if (!confirm('Confirma a remoção deste serviço?')) return;
  try {
    await apiDelete(`/servicos/${id}`);
    await preencherTabelaServicos();
  } catch (e) {
    alert('Erro ao apagar serviço: ' + e.message);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btn-novo-servico').addEventListener('click', openModal);
  document.getElementById('btn-refresh-servicos').addEventListener('click', preencherTabelaServicos);

  document.getElementById('modal-close').addEventListener('click', closeModal);
  document.querySelectorAll('.form-actions .btn:not([type="submit"])').forEach(btn => {
    btn.addEventListener('click', closeModal);
  });

  document.getElementById('form-servico').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
      nome_servico: document.getElementById('nome_servico').value,
      preco: parseFloat(document.getElementById('preco').value)
    };

    try {
      await apiPost('/servicos', payload);
      closeModal();
      await preencherTabelaServicos();
    } catch (err) {
      alert('Erro ao salvar serviço: ' + err.message);
    }
  });

  document.querySelector('#table-servicos tbody').addEventListener('click', (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    if (action === 'delete') apagarServico(id);
  });

  preencherTabelaServicos();
});
</script>
{% endblock %}