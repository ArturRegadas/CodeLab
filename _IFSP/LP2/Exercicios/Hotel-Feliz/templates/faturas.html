{% extends 'base.html' %}
{% block title %}Faturas - Estada Feliz{% endblock %}

{% block content %}
<section class="page-header">
  <h2>Faturas</h2>
  <div class="actions">
    <button id="btn-nova-fatura" class="btn">Nova Fatura</button>
    <button id="btn-refresh-faturas" class="btn">Atualizar</button>
  </div>
</section>

<section class="table-wrap">
  <table id="table-faturas" class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Reserva</th>
        <th>Valor Diárias</th>
        <th>Valor Serviços</th>
        <th>Total</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Modal: Criar Fatura -->
<div id="modal-fatura" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" id="modal-close">×</button>
    <h3>Criar Fatura</h3>

    <form id="form-fatura">
      <div class="form-row">
        <label for="id_reserva">Reserva</label>
        <select id="id_reserva" name="id_reserva" required>
          <option value="">Carregando...</option>
        </select>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">Criar</button>
        <button type="button" class="btn" id="cancel-fatura">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Itens da Fatura -->
<div id="modal-itens" class="modal" aria-hidden="true">
  <div class="modal-content large">
    <button class="modal-close" id="modal-close-itens">×</button>
    <h3>Itens da Fatura</h3>

    <section>
      <table class="table" id="table-itens">
        <thead>
          <tr>
            <th>Serviço</th>
            <th>Quantidade</th>
            <th>Preço Unitário</th>
            <th>Data</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <h4>Adicionar Item</h4>
    <form id="form-item">
      <div class="form-row">
        <label for="add_servico">Serviço</label>
        <select id="add_servico" required></select>
      </div>

      <div class="form-row">
        <label for="add_qtd">Quantidade</label>
        <input type="number" id="add_qtd" min="1" value="1" required />
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">Adicionar</button>
      </div>

      <input type="hidden" id="id_fatura_atual" />
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Funções utilitárias para abrir/fechar modais
function openModal(id){
  const m = document.getElementById(id);
  m.style.display = 'block';
  m.setAttribute('aria-hidden', 'false');
}
function closeModal(id){
  const m = document.getElementById(id);
  m.style.display = 'none';
  m.setAttribute('aria-hidden', 'true');
}

async function carregarReservasSelect(){
  const sel = document.getElementById('id_reserva');
  try{
    const reservas = await apiGet('/reservas');
    sel.innerHTML = '<option value="">-- selecione --</option>';
    reservas.forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r.id_reserva;
      opt.textContent = `Reserva ${r.id_reserva} - Quarto ${r.numero_quarto ?? 'N/A'}`;
      sel.appendChild(opt);
    });
  }catch(e){
    sel.innerHTML = '<option value="">Erro ao carregar</option>';
  }
}

async function preencherTabelaFaturas(){
  const tbody = document.querySelector('#table-faturas tbody');
  tbody.innerHTML = '';
  try{
    const faturas = await apiGet('/faturas_list'); // É recomendável criar GET /faturas_list retornando todas as faturas
    faturas.forEach(f=>{
      const total = (parseFloat(f.valor_diarias) + parseFloat(f.valor_servicos)).toFixed(2);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${f.id_fatura}</td>
        <td>${f.id_reserva}</td>
        <td>R$ ${parseFloat(f.valor_diarias).toFixed(2)}</td>
        <td>R$ ${parseFloat(f.valor_servicos).toFixed(2)}</td>
        <td>R$ ${total}</td>
        <td>${f.status_pagamento}</td>
        <td>
          <button class="btn small" data-action="view" data-id="${f.id_fatura}">Ver Itens</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }catch(err){ console.error(err); }
}

async function abrirItensFatura(id){
  document.getElementById('id_fatura_atual').value = id;

  const tbody = document.querySelector('#table-itens tbody');
  tbody.innerHTML = '';

  try{
    const f = await apiGet(`/faturas/${id}`);

    f.itens.forEach(i=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i.servico.nome_servico}</td>
        <td>${i.quantidade}</td>
        <td>R$ ${parseFloat(i.preco_unitario_registro).toFixed(2)}</td>
        <td>${i.data_consumo}</td>
      `;
      tbody.appendChild(tr);
    });

    await carregarServicosSelect();
    openModal('modal-itens');

  }catch(e){ console.error(e); }
}

async function carregarServicosSelect(){
  const sel = document.getElementById('add_servico');
  sel.innerHTML = '<option>Carregando...</option>';
  try{
    const servicos = await apiGet('/servicos');
    sel.innerHTML = '';
    servicos.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.id_servico;
      opt.textContent = `${s.nome_servico} - R$ ${parseFloat(s.preco).toFixed(2)}`;
      sel.appendChild(opt);
    });
  }catch(err){ sel.innerHTML='<option>Erro</option>'; }
}

// Eventos globais

document.addEventListener('DOMContentLoaded',()=>{

  document.getElementById('btn-refresh-faturas').addEventListener('click', preencherTabelaFaturas);

  document.getElementById('btn-nova-fatura').addEventListener('click', async()=>{
    await carregarReservasSelect();
    openModal('modal-fatura');
  });

  document.getElementById('cancel-fatura').addEventListener('click',()=> closeModal('modal-fatura'));
  document.getElementById('modal-close').addEventListener('click',()=> closeModal('modal-fatura'));

  document.getElementById('modal-close-itens').addEventListener('click',()=> closeModal('modal-itens'));

  document.querySelector('#table-faturas tbody').addEventListener('click',(ev)=>{
    const b = ev.target.closest('button');
    if(!b) return;
    if(b.dataset.action==='view') abrirItensFatura(b.dataset.id);
  });

  document.getElementById('form-fatura').addEventListener('submit', async(e)=>{
    e.preventDefault();
    const id_reserva = document.getElementById('id_reserva').value;
    await apiPost('/faturas',{id_reserva});
    closeModal('modal-fatura');
    preencherTabelaFaturas();
  });

  document.getElementById('form-item').addEventListener('submit', async(e)=>{
    e.preventDefault();
    const id_fatura = document.getElementById('id_fatura_atual').value;
    const id_servico = document.getElementById('add_servico').value;
    const quantidade = document.getElementById('add_qtd').value;
    await apiPost(`/faturas/${id_fatura}/itens`,{id_servico, quantidade});
    abrirItensFatura(id_fatura);
  });

  preencherTabelaFaturas();
});
</script>
{% endblock %}