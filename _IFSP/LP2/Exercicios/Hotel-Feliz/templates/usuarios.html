{% extends 'base.html' %}
{% block title %}Usuários - Estada Feliz{% endblock %}

{% block content %}
<section class="page-header">
  <h2>Usuários</h2>
  <div class="actions">
    <button id="btn-novo-usuario" class="btn">Novo Usuário</button>
    <button id="btn-refresh-usuarios" class="btn">Atualizar</button>
  </div>
</section>

<section class="table-wrap">
  <table id="table-usuarios" class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Email</th>
        <th>Perfil</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Modal Criar/Editar Usuário -->
<div id="modal-usuario" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" id="modal-close-usuario">×</button>
    <h3 id="titulo-modal-usuario">Novo Usuário</h3>

    <form id="form-usuario">

      <div class="form-row">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required />
      </div>

      <div class="form-row">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required />
      </div>

      <div class="form-row">
        <label for="senha">Senha</label>
        <input type="password" id="senha" name="senha" required />
      </div>

      <div class="form-row">
        <label for="perfil">Perfil</label>
        <select id="perfil" name="perfil" required></select>
      </div>

      <input type="hidden" id="id_usuario" />

      <div class="form-actions">
        <button type="submit" class="btn primary">Salvar</button>
        <button type="button" class="btn" id="cancel-usuario">Cancelar</button>
      </div>

    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openModal(id){
  const m = document.getElementById(id);
  m.style.display = 'block';
  m.setAttribute('aria-hidden','false');
}
function closeModal(id){
  const m = document.getElementById(id);
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
}

async function carregarPerfis(){
  const sel = document.getElementById('perfil');
  sel.innerHTML = '<option>Carregando...</option>';
  try{
    const perfis = await apiGet('/perfis');
    sel.innerHTML = '';
    perfis.forEach(p=>{
      const o = document.createElement('option');
      o.value = p.id_perfil;
      o.textContent = p.nome;
      sel.appendChild(o);
    });
  }catch(e){ sel.innerHTML='<option>Erro</option>'; }
}

async function carregarUsuarios(){
  const tbody = document.querySelector('#table-usuarios tbody');
  tbody.innerHTML = '';
  try{
    const usuarios = await apiGet('/usuarios');
    usuarios.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id_usuario}</td>
        <td>${u.nome}</td>
        <td>${u.email}</td>
        <td>${u.perfil.nome}</td>
        <td>
          <button class="btn small" data-action="edit" data-id="${u.id_usuario}">Editar</button>
          <button class="btn small" data-action="del" data-id="${u.id_usuario}">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}

document.addEventListener('DOMContentLoaded',()=>{
  carregarUsuarios();

  document.getElementById('btn-refresh-usuarios').addEventListener('click', carregarUsuarios);

  document.getElementById('btn-novo-usuario').addEventListener('click', async()=>{
    document.getElementById('form-usuario').reset();
    document.getElementById('id_usuario').value='';
    document.getElementById('titulo-modal-usuario').textContent='Novo Usuário';
    await carregarPerfis();
    openModal('modal-usuario');
  });

  document.getElementById('cancel-usuario').addEventListener('click',()=> closeModal('modal-usuario'));
  document.getElementById('modal-close-usuario').addEventListener('click',()=> closeModal('modal-usuario'));

  document.querySelector('#table-usuarios tbody').addEventListener('click',(ev)=>{
    const btn = ev.target.closest('button');
    if(!btn) return;

    const id = btn.dataset.id;
    if(btn.dataset.action==='edit') editarUsuario(id);
    if(btn.dataset.action==='del') excluirUsuario(id);
  });

  document.getElementById('form-usuario').addEventListener('submit', async(e)=>{
    e.preventDefault();
    const id = document.getElementById('id_usuario').value;

    const data = {
      nome: document.getElementById('nome').value,
      email: document.getElementById('email').value,
      senha: document.getElementById('senha').value,
      id_perfil: document.getElementById('perfil').value
    };

    if(id){
      await apiPut(`/usuarios/${id}`, data);
    }else{
      await apiPost('/usuarios', data);
    }

    closeModal('modal-usuario');
    carregarUsuarios();
  });
});

async function editarUsuario(id){
  try{
    const u = await apiGet(`/usuarios/${id}`);

    document.getElementById('id_usuario').value = u.id_usuario;
    document.getElementById('nome').value = u.nome;
    document.getElementById('email').value = u.email;
    document.getElementById('senha').value = '';

    await carregarPerfis();
    document.getElementById('perfil').value = u.id_perfil;

    document.getElementById('titulo-modal-usuario').textContent = 'Editar Usuário';
    openModal('modal-usuario');
  }catch(e){ console.error(e); }
}

async function excluirUsuario(id){
  if(!confirm('Excluir usuário?')) return;
  await apiDelete(`/usuarios/${id}`);
  carregarUsuarios();
}
</script>
{% endblock %}